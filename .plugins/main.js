(function(d,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("react/jsx-runtime"),require("@kinvolk/headlamp-plugin/lib"),require("@kinvolk/headlamp-plugin/lib/CommonComponents"),require("@mui/material"),require("react"),require("react-router-dom"),require("@kinvolk/headlamp-plugin/lib/lib/k8s/crd"),require("@kinvolk/headlamp-plugin/lib/lib/k8s/apiProxy")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@kinvolk/headlamp-plugin/lib","@kinvolk/headlamp-plugin/lib/CommonComponents","@mui/material","react","react-router-dom","@kinvolk/headlamp-plugin/lib/lib/k8s/crd","@kinvolk/headlamp-plugin/lib/lib/k8s/apiProxy"],e):(d=typeof globalThis<"u"?globalThis:d||self,e(d.main={},d.pluginLib.ReactJSX,d.pluginLib,d.pluginLib.CommonComponents,d.pluginLib.MuiMaterial,d.pluginLib.React,d.pluginLib.ReactRouter,d.pluginLib.Crd,d.pluginLib.libk8sapiProxy))})(this,function(d,e,f,p,n,k,N,w,C){"use strict";const V=(r=>r&&typeof r=="object"&&"default"in r?r:{default:r})(k),P=[{group:"templates.gatekeeper.sh",version:"v1beta1"}],S=w.makeCustomResourceClass({apiInfo:P,isNamespaced:!1,singularName:"constrainttemplate",pluralName:"constrainttemplates"}),v={useApiList:r=>{const c=async()=>{try{const h=await C.request("/api/v1",{isJSON:!0}),o=await C.request("/apis/constraints.gatekeeper.sh/v1beta1",{isJSON:!0});if(o&&o.resources){const u=[];await Promise.all(o.resources.map(async t=>{var s;if(t.namespaced===!1&&((s=t.verbs)!=null&&s.includes("list")))try{const a=await C.request(`/apis/constraints.gatekeeper.sh/v1beta1/${t.name}`,{isJSON:!0});a&&a.items&&u.push(...a.items)}catch(a){console.warn(`Failed to fetch ${t.name}:`,a)}})),r(u)}else r([])}catch(h){console.error("Failed to fetch constraints:",h),r([])}};V.default.useEffect(()=>{c()},[])},useApiGet:(r,c,h)=>{const o=async()=>{var u;try{if(h){const t=await C.request(`/apis/constraints.gatekeeper.sh/v1beta1/${h}/${c}`,{isJSON:!0});r(t)}else{const t=await C.request("/apis/constraints.gatekeeper.sh/v1beta1",{isJSON:!0});if(t&&t.resources){for(const s of t.resources)if(s.namespaced===!1&&((u=s.verbs)!=null&&u.includes("get")))try{const a=await C.request(`/apis/constraints.gatekeeper.sh/v1beta1/${s.name}/${c}`,{isJSON:!0});if(a){r(a);return}}catch{}}r(null)}}catch(t){console.error("Failed to fetch constraint:",t),r(null)}};V.default.useEffect(()=>{o()},[c,h])}};function A({}){var a;const{name:r}=N.useParams(),[c,h]=k.useState(null);if(v.useApiGet(h,r),!c)return e.jsx(n.Typography,{children:"Loading constraint details..."});const o=c.jsonData;function u(){var b,T,g,y;const l=((b=o.spec)==null?void 0:b.enforcementAction)||"warn",i={deny:"error",dryrun:"warning",warn:"info"}[l];return[{name:"Name",value:o.metadata.name},{name:"Kind",value:o.kind},{name:"Created",value:o.metadata.creationTimestamp},{name:"Enforcement Action",value:e.jsx(n.Chip,{label:l,color:i,size:"small"})},{name:"Total Violations",value:((g=(T=o.status)==null?void 0:T.totalViolations)==null?void 0:g.toString())||"0"},{name:"Last Audit",value:((y=o.status)==null?void 0:y.auditTimestamp)||"Never"}]}function t(){var b;if(!((b=o.spec)!=null&&b.match))return[];const l=o.spec.match,i=[];return l.kinds&&l.kinds.forEach((T,g)=>{i.push({Property:"API Groups",Value:T.apiGroups.join(", "),Index:`kinds-${g}-apiGroups`}),i.push({Property:"Kinds",Value:T.kinds.join(", "),Index:`kinds-${g}-kinds`})}),l.excludedNamespaces&&i.push({Property:"Excluded Namespaces",Value:l.excludedNamespaces.join(", "),Index:"excludedNamespaces"}),i}function s(){var l;return(l=o.status)!=null&&l.violations?o.status.violations.map((i,b)=>({Resource:`${i.kind}/${i.name}`,Namespace:i.namespace||"cluster-scoped",Message:i.message,Index:b})):[]}return e.jsxs(n.Box,{children:[e.jsx(n.Typography,{variant:"h4",gutterBottom:!0,children:o.metadata.name}),e.jsxs(n.Typography,{variant:"subtitle1",color:"textSecondary",gutterBottom:!0,children:[o.kind," Constraint"]}),e.jsx(p.SectionBox,{title:"Overview",children:e.jsx(n.Table,{children:e.jsx(n.TableBody,{children:u().map(l=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{component:"th",scope:"row",children:l.name}),e.jsx(n.TableCell,{children:l.value})]},l.name))})})}),e.jsx(p.SectionBox,{title:"Match Rules",children:e.jsxs(n.Table,{children:[e.jsx(n.TableHead,{children:e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:"Property"}),e.jsx(n.TableCell,{children:"Value"})]})}),e.jsx(n.TableBody,{children:t().map(l=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:l.Property}),e.jsx(n.TableCell,{children:l.Value})]},l.Index))})]})}),e.jsx(p.SectionBox,{title:`Violations (${((a=o.status)==null?void 0:a.totalViolations)||0})`,children:e.jsxs(n.Table,{children:[e.jsx(n.TableHead,{children:e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:"Resource"}),e.jsx(n.TableCell,{children:"Namespace"}),e.jsx(n.TableCell,{children:"Message"})]})}),e.jsx(n.TableBody,{children:s().map(l=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:l.Resource}),e.jsx(n.TableCell,{children:l.Namespace}),e.jsx(n.TableCell,{children:l.Message})]},l.Index))})]})})]})}function B({}){const[r,c]=k.useState(null);if(v.useApiList(c),!r)return e.jsx(n.Typography,{children:"Loading constraints..."});const h=r.map(s=>s.jsonData);function o(s){var i;const a=((i=s.spec)==null?void 0:i.enforcementAction)||"warn",l={deny:"error",dryrun:"warning",warn:"info"}[a];return e.jsx(n.Chip,{label:a,color:l,size:"small"})}function u(s){var a,l;return((l=(a=s.status)==null?void 0:a.totalViolations)==null?void 0:l.toString())||"0"}function t(s){var a,l;return(l=(a=s.spec)==null?void 0:a.match)!=null&&l.kinds?s.spec.match.kinds.map(i=>i.kinds.join(", ")).join("; "):""}return e.jsx(p.SectionBox,{title:"Constraints",children:e.jsxs(n.Table,{children:[e.jsx(n.TableHead,{children:e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:"Name"}),e.jsx(n.TableCell,{children:"Kind"}),e.jsx(n.TableCell,{children:"Enforcement Action"}),e.jsx(n.TableCell,{children:"Matched Kinds"}),e.jsx(n.TableCell,{children:"Violations"}),e.jsx(n.TableCell,{children:"Age"})]})}),e.jsx(n.TableBody,{children:h.map(s=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:e.jsx(p.Link,{routeName:d.RoutingPath.Constraint,params:{kind:s.kind,name:s.metadata.name},children:s.metadata.name})}),e.jsx(n.TableCell,{children:s.kind}),e.jsx(n.TableCell,{children:o(s)}),e.jsx(n.TableCell,{children:t(s)}),e.jsx(n.TableCell,{children:u(s)}),e.jsx(n.TableCell,{children:s.metadata.creationTimestamp})]},`${s.kind}-${s.metadata.name}`))})]})})}function x({}){const{name:r}=N.useParams(),[c,h]=k.useState(null);if(S.useApiGet(h,r),!c)return e.jsx(n.Typography,{children:"Loading constraint template details..."});const o=c.jsonData;function u(){var s,a,l,i,b,T,g,y,L;return[{name:"Name",value:o.metadata.name},{name:"Created",value:o.metadata.creationTimestamp},{name:"Kind",value:((i=(l=(a=(s=o.spec)==null?void 0:s.crd)==null?void 0:a.spec)==null?void 0:l.names)==null?void 0:i.kind)||""},{name:"Plural",value:((y=(g=(T=(b=o.spec)==null?void 0:b.crd)==null?void 0:T.spec)==null?void 0:g.names)==null?void 0:y.plural)||""},{name:"Status",value:(L=o.status)!=null&&L.created?"Ready":"Not Ready"}]}function t(){var s;return(s=o.spec)!=null&&s.targets?o.spec.targets.map(a=>({Target:a.target,"Has Rego":a.rego?"Yes":"No","Has Libs":a.libs&&a.libs.length>0?"Yes":"No"})):[]}return e.jsxs(n.Box,{children:[e.jsx(n.Typography,{variant:"h4",gutterBottom:!0,children:o.metadata.name}),e.jsx(n.Typography,{variant:"subtitle1",color:"textSecondary",gutterBottom:!0,children:"Constraint Template"}),e.jsx(p.SectionBox,{title:"Overview",children:e.jsx(n.Table,{children:e.jsx(n.TableBody,{children:u().map(s=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{component:"th",scope:"row",children:s.name}),e.jsx(n.TableCell,{children:s.value})]},s.name))})})}),e.jsx(p.SectionBox,{title:"Targets",children:e.jsxs(n.Table,{children:[e.jsx(n.TableHead,{children:e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:"Target"}),e.jsx(n.TableCell,{children:"Has Rego"}),e.jsx(n.TableCell,{children:"Has Libs"})]})}),e.jsx(n.TableBody,{children:t().map((s,a)=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:s.Target}),e.jsx(n.TableCell,{children:s["Has Rego"]}),e.jsx(n.TableCell,{children:s["Has Libs"]})]},a))})]})})]})}function I({}){const[r,c]=k.useState(null);if(S.useApiList(c),!r)return e.jsx(n.Typography,{children:"Loading constraint templates..."});const h=r.map(t=>t.jsonData);function o(t){const s=t.status;return s?s.created?"Ready":"Not Ready":"Unknown"}function u(t){var s,a;return((a=(s=t.spec)==null?void 0:s.targets)==null?void 0:a.map(l=>l.target).join(", "))||""}return e.jsx(p.SectionBox,{title:"Constraint Templates",children:e.jsxs(n.Table,{children:[e.jsx(n.TableHead,{children:e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:"Name"}),e.jsx(n.TableCell,{children:"Kind"}),e.jsx(n.TableCell,{children:"Targets"}),e.jsx(n.TableCell,{children:"Status"}),e.jsx(n.TableCell,{children:"Age"})]})}),e.jsx(n.TableBody,{children:h.map(t=>{var s,a,l,i;return e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:e.jsx(p.Link,{routeName:d.RoutingPath.ConstraintTemplate,params:{name:t.metadata.name},children:t.metadata.name})}),e.jsx(n.TableCell,{children:((i=(l=(a=(s=t.spec)==null?void 0:s.crd)==null?void 0:a.spec)==null?void 0:l.names)==null?void 0:i.kind)||""}),e.jsx(n.TableCell,{children:u(t)}),e.jsx(n.TableCell,{children:o(t)}),e.jsx(n.TableCell,{children:t.metadata.creationTimestamp})]},t.metadata.name)})})]})})}function M({}){var s;const{name:r}=N.useParams(),[c,h]=k.useState(null);if(v.useApiGet(h,r),!c)return e.jsx(p.Loader,{title:"Loading violation details"});function o(){var i,b,T,g;if(!c)return[];const a=((i=c.spec)==null?void 0:i.enforcementAction)||"warn",l={deny:"error",dryrun:"warning",warn:"info"}[a];return[{name:"Constraint Name",value:e.jsx(p.Link,{routeName:"gatekeeper/constraints/:kind/:name",params:{kind:c.kind,name:c.metadata.name},children:c.metadata.name})},{name:"Constraint Kind",value:c.kind},{name:"Enforcement Action",value:e.jsx(n.Chip,{label:a,color:l,size:"small"})},{name:"Total Violations",value:((T=(b=c.status)==null?void 0:b.totalViolations)==null?void 0:T.toString())||"0"},{name:"Last Audit",value:((g=c.status)==null?void 0:g.auditTimestamp)||"Never"}]}function u(){var a;return!c||!((a=c.status)!=null&&a.violations)?[]:c.status.violations.map((l,i)=>({Resource:`${l.kind}/${l.name}`,Namespace:l.namespace||"cluster-scoped","API Version":l.apiVersion,Message:l.message,Index:i}))}function t(){var i;if(!c||!((i=c.spec)!=null&&i.match))return[];const a=c.spec.match,l=[];return a.kinds&&a.kinds.forEach((b,T)=>{l.push({Property:"API Groups",Value:b.apiGroups.join(", "),Index:`kinds-${T}-apiGroups`}),l.push({Property:"Kinds",Value:b.kinds.join(", "),Index:`kinds-${T}-kinds`})}),a.excludedNamespaces&&l.push({Property:"Excluded Namespaces",Value:a.excludedNamespaces.join(", "),Index:"excludedNamespaces"}),l}return e.jsxs(n.Box,{children:[e.jsxs(n.Typography,{variant:"h4",gutterBottom:!0,children:["Violations for ",c.metadata.name]}),e.jsxs(n.Typography,{variant:"subtitle1",color:"textSecondary",gutterBottom:!0,children:[c.kind," Constraint Violations"]}),e.jsx(p.SectionBox,{title:"Constraint Details",children:e.jsx(n.Table,{children:e.jsx(n.TableBody,{children:o().map(a=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{component:"th",scope:"row",children:a.name}),e.jsx(n.TableCell,{children:a.value})]},a.name))})})}),e.jsx(p.SectionBox,{title:"Match Rules",children:e.jsx(p.SimpleTable,{data:t(),columns:[{label:"Property",getter:a=>a.Property},{label:"Value",getter:a=>a.Value}]})}),e.jsx(p.SectionBox,{title:`Violations (${((s=c.status)==null?void 0:s.totalViolations)||0})`,children:e.jsx(p.SimpleTable,{data:u(),columns:[{label:"Resource",getter:a=>a.Resource},{label:"Namespace",getter:a=>a.Namespace},{label:"API Version",getter:a=>a["API Version"]},{label:"Message",getter:a=>a.Message}]})})]})}function $({}){const[r,c]=k.useState(null);v.useApiList(c);const h=V.default.useMemo(()=>{if(!r)return[];const t=[];return r.forEach(s=>{var a;(a=s.status)!=null&&a.violations&&s.status.violations.forEach(l=>{var i;t.push({...l,constraintName:s.metadata.name,constraintKind:s.kind,enforcementAction:((i=s.spec)==null?void 0:i.enforcementAction)||"warn"})})}),t},[r]);function o(t){const s=t.enforcementAction,a={deny:"error",dryrun:"warning",warn:"info"}[s];return e.jsx(n.Chip,{label:s,color:a,size:"small"})}function u(t){return t.namespace?`${t.namespace}/${t.name}`:t.name}return e.jsxs(p.SectionBox,{title:"Violations",children:[e.jsx(p.SectionFilterHeader,{title:"Violations"}),r?e.jsx(n.TableContainer,{component:n.Paper,children:e.jsxs(n.Table,{children:[e.jsx(n.TableHead,{children:e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:"Resource"}),e.jsx(n.TableCell,{children:"Kind"}),e.jsx(n.TableCell,{children:"Constraint"}),e.jsx(n.TableCell,{children:"Constraint Kind"}),e.jsx(n.TableCell,{children:"Enforcement"}),e.jsx(n.TableCell,{children:"Message"})]})}),e.jsx(n.TableBody,{children:h.map((t,s)=>e.jsxs(n.TableRow,{children:[e.jsx(n.TableCell,{children:e.jsx(p.Link,{routeName:"gatekeeper/violations/:kind/:name",params:{kind:t.constraintKind,name:t.constraintName},children:u(t)})}),e.jsx(n.TableCell,{children:t.kind}),e.jsx(n.TableCell,{children:e.jsx(p.Link,{routeName:"gatekeeper/constraints/:kind/:name",params:{kind:t.constraintKind,name:t.constraintName},children:t.constraintName})}),e.jsx(n.TableCell,{children:t.constraintKind}),e.jsx(n.TableCell,{children:o(t)}),e.jsx(n.TableCell,{children:t.message})]},s))})]})}):e.jsx(p.Loader,{title:"Loading violations"})]})}d.RoutingPath=void 0,(r=>{r.ConstraintTemplates="/gatekeeper/constraint-templates",r.ConstraintTemplate="/gatekeeper/constraint-templates/:name",r.Constraints="/gatekeeper/constraints",r.Constraint="/gatekeeper/constraints/:kind/:name",r.Violations="/gatekeeper/violations",r.Violation="/gatekeeper/violations/:kind/:name"})(d.RoutingPath||(d.RoutingPath={})),f.registerSidebarEntry({parent:null,name:"gatekeeper",label:"Gatekeeper",icon:"mdi:shield-check",url:d.RoutingPath.ConstraintTemplates}),f.registerSidebarEntry({parent:"gatekeeper",name:"constrainttemplates",label:"Constraint Templates",url:d.RoutingPath.ConstraintTemplates}),f.registerSidebarEntry({parent:"gatekeeper",name:"constraints",label:"Constraints",url:d.RoutingPath.Constraints}),f.registerSidebarEntry({parent:"gatekeeper",name:"violations",label:"Violations",url:d.RoutingPath.Violations}),f.registerRoute({path:d.RoutingPath.ConstraintTemplates,sidebar:"constrainttemplates",name:"Constraint Templates",exact:!0,component:()=>e.jsx(I,{})}),f.registerRoute({path:d.RoutingPath.ConstraintTemplate,sidebar:"constrainttemplates",name:"Constraint Template Details",exact:!0,component:()=>e.jsx(x,{})}),f.registerRoute({path:d.RoutingPath.Constraints,sidebar:"constraints",name:"Constraints",exact:!0,component:()=>e.jsx(B,{})}),f.registerRoute({path:d.RoutingPath.Constraint,sidebar:"constraints",name:"Constraint Details",exact:!0,component:()=>e.jsx(A,{})}),f.registerRoute({path:d.RoutingPath.Violations,sidebar:"violations",name:"Violations",exact:!0,component:()=>e.jsx($,{})}),f.registerRoute({path:d.RoutingPath.Violation,sidebar:"violations",name:"Violation Details",exact:!0,component:()=>e.jsx(M,{})});const j={name:"gatekeeper-headlamp-plugin",version:"0.1.0",description:"Headlamp plugin for OPA Gatekeeper policies and violations"};d.default=j,Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
